<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Downtime Table</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #f3f4f6;
  margin: 0;
  color: #1e293b;
}
.page { padding: 20px; }
.card {
  background: #ffffff;
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,.08);
  margin-bottom: 20px;
}
h2 { margin: 0 0 14px; color: #1e3a8a; font-size: 18px; }
.filters { display: flex; gap: 12px; align-items: center; }
select, button {
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid #cbd5e1;
  font-size: 14px;
}
button {
  background: #2563eb;
  color: #fff;
  border: none;
  cursor: pointer;
  font-weight: 600;
}
button:hover { background: #1d4ed8; }

table { width: 100%; border-collapse: collapse; }
th, td {
  padding: 10px;
  border-bottom: 1px solid #e5e7eb;
  text-align: left;
}
th { background: #f1f5f9; }
.dot { cursor: pointer; font-weight: bold; float: right; }

#status { font-size: 14px; color: #475569; }

/* Modal */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  z-index: 10;
}
.modal-box {
  background: #fff;
  width: 420px;
  margin: 8% auto;
  padding: 20px;
  border-radius: 10px;
}
</style>
</head>

<body>
<div class="page">

<!-- FILTER -->
<div class="card">
  <h2>Downtime Events</h2>
  <div class="filters">
    <select id="range">
      <option value="24H">Last 24 Hours</option>
      <option value="WEEK">This Week</option>
    </select>
    <button onclick="loadTable()">Generate</button>
    <span id="status">—</span>
  </div>
</div>

<!-- TABLE -->
<div class="card">
  <table>
    <thead>
      <tr>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Duration (min)</th>
        <th>Downtime Description</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <tr><td colspan="4">Select range and click Generate</td></tr>
    </tbody>
  </table>
</div>

</div>

<!-- MODAL -->
<div id="editModal" class="modal">
  <div class="modal-box">
    <h3>Edit Downtime Reason</h3>

    <p><b>Start:</b> <span id="mStart"></span></p>
    <p><b>End:</b> <span id="mEnd"></span></p>
    <p><b>Duration:</b> <span id="mDuration"></span> min</p>

    <label>Downtime Reason</label>
    <select id="mReason" style="width:100%;margin:10px 0">
      <option>Power failure</option>
      <option>Planned maintenance</option>
      <option>Material shortage</option>
      <option>Changeover / Setup</option>
      <option>Lubrication cycle</option>
      <option>Quality inspection hold</option>
      <option>Unplanned breakdown</option>
      <option>Overheat cooldown</option>
      <option>Safety interlock opened</option>
      <option>Cleaning / 5S</option>
    </select>

    <button onclick="submitReason()">Submit</button>
    <button onclick="closeModal()" style="background:#e5e7eb;color:#000">Cancel</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const CONFIG = {
  API: "https://plantwiz.pimateck.in/api",
  DEVICE_ID: "991cf500-661a-11f0-90f1-775fee303094",
  KEYS: [
    "Downtime_Start_Time",
    "Downtime_End_Time",
    "Downtime_Duration",
    "Downtime_Description"
  ]
};

const JWT = new URLSearchParams(location.search).get("token") || "";
let selectedDescTs = null;

/* ================= HELPERS ================= */
function fmtDate(v) {
  if (!v) return "—";
  return new Date(v.replace(" ", "T")).toLocaleString();
}
function secToMin(v) {
  return Math.round(Number(v || 0) / 60);
}

/* ================= RANGE ================= */
function getRange() {
  const t = document.getElementById("range").value;
  const now = Date.now();
  if (t === "24H") return { startTs: now - 86400000, endTs: now };
  const d = new Date();
  d.setHours(0,0,0,0);
  d.setDate(d.getDate() - d.getDay());
  return { startTs: d.getTime(), endTs: now };
}

/* ================= FETCH ================= */
async function fetchData() {
  const { startTs, endTs } = getRange();
  const url =
    `${CONFIG.API}/plugins/telemetry/DEVICE/${CONFIG.DEVICE_ID}/values/timeseries` +
    `?keys=${CONFIG.KEYS.join(",")}&startTs=${startTs}&endTs=${endTs}` +
    `&limit=1000&agg=NONE`;

  const r = await fetch(url, {
    headers: { "X-Authorization": `Bearer ${JWT}` }
  });
  return r.json();
}

/* ================= BUILD ROWS (CRITICAL) ================= */
function buildRows(data) {
  const rows = {};

  (data.Downtime_Description || []).forEach(p => {
    rows[p.ts] = { desc: p.value, descTs: p.ts };
  });

  (data.Downtime_Start_Time || []).forEach(p => {
    rows[p.ts] = { ...(rows[p.ts] || {}), start: p.value };
  });

  (data.Downtime_End_Time || []).forEach(p => {
    rows[p.ts] = { ...(rows[p.ts] || {}), end: p.value };
  });

  (data.Downtime_Duration || []).forEach(p => {
    rows[p.ts] = { ...(rows[p.ts] || {}), dur: p.value };
  });

  return Object.values(rows);
}

/* ================= RENDER ================= */
function render(rows) {
  const tb = document.getElementById("tableBody");
  tb.innerHTML = "";

  if (!rows.length) {
    tb.innerHTML = "<tr><td colspan='4'>No downtime found</td></tr>";
    return;
  }

  rows.forEach(r => {
    tb.innerHTML += `
      <tr>
        <td>${fmtDate(r.start)}</td>
        <td>${fmtDate(r.end)}</td>
        <td>${secToMin(r.dur)}</td>
        <td>
          ${r.desc || "—"}
          <span class="dot" onclick='openModal(${JSON.stringify(r)})'>⋮</span>
        </td>
      </tr>`;
  });
}

/* ================= MODAL ================= */
function openModal(r) {
  selectedDescTs = r.descTs;
  mStart.textContent = fmtDate(r.start);
  mEnd.textContent = fmtDate(r.end);
  mDuration.textContent = secToMin(r.dur);
  mReason.value = r.desc || "";
  editModal.style.display = "block";
}
function closeModal() {
  editModal.style.display = "none";
}

/* ================= UPDATE ================= */
async function submitReason() {
  await fetch(
    `${CONFIG.API}/plugins/telemetry/DEVICE/${CONFIG.DEVICE_ID}/timeseries/ANY?ts=${selectedDescTs}`,
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Authorization": `Bearer ${JWT}`
      },
      body: JSON.stringify({ Downtime_Description: mReason.value })
    }
  );
  closeModal();
  loadTable();
}

/* ================= MAIN ================= */
async function loadTable() {
  status.textContent = "Loading...";
  const raw = await fetchData();
  const rows = buildRows(raw);
  render(rows);
  status.textContent = "Loaded ✅";
}
</script>
</body>
</html>
