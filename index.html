<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Downtime Table</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Segoe UI",sans-serif;
  background:#f3f4f6;
  margin:0;color:#1e293b
}
.page{padding:20px}
.card{
  background:#fff;border-radius:12px;
  padding:16px 20px;margin-bottom:20px;
  box-shadow:0 2px 10px rgba(0,0,0,.08)
}
h2{margin:0 0 14px;color:#1e3a8a;font-size:18px}
.filters{display:flex;gap:12px;align-items:center}
select,button{
  padding:8px 12px;border-radius:6px;
  border:1px solid #cbd5e1;font-size:14px
}
button{
  background:#2563eb;color:#fff;
  border:none;cursor:pointer;font-weight:600
}
button:hover{background:#1d4ed8}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left}
th{background:#f1f5f9}
.dot{cursor:pointer;font-weight:bold;float:right}
#status{font-size:14px;color:#475569}

/* Modal */
.modal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.4);z-index:10
}
.modal-box{
  background:#fff;width:420px;
  margin:8% auto;padding:20px;
  border-radius:10px
}
</style>
</head>

<body>
<div class="page">

<!-- FILTER -->
<div class="card">
<h2>Downtime Events</h2>
<div class="filters">
<select id="range">
<option value="24H">Last 24 Hours</option>
<option value="WEEK">This Week</option>
</select>
<button onclick="loadTable()">Generate</button>
<span id="status">—</span>
</div>
</div>

<!-- TABLE -->
<div class="card">
<table>
<thead>
<tr>
<th>Start Time</th>
<th>End Time</th>
<th>Duration (min)</th>
<th>Downtime Description</th>
</tr>
</thead>
<tbody id="downtimeTable">
<tr><td colspan="4">Select range & click Generate</td></tr>
</tbody>
</table>
</div>

</div>

<!-- MODAL -->
<div id="editModal" class="modal">
<div class="modal-box">
<h3>Edit Downtime Reason</h3>

<p><b>Start:</b> <span id="mStart"></span></p>
<p><b>End:</b> <span id="mEnd"></span></p>
<p><b>Duration:</b> <span id="mDuration"></span> min</p>

<label>Downtime Reason</label>
<select id="mReason" style="width:100%;margin:10px 0">
<option>Power failure</option>
<option>Planned maintenance</option>
<option>Material shortage</option>
<option>Changeover / Setup</option>
<option>Lubrication cycle</option>
<option>Quality inspection hold</option>
<option>Unplanned breakdown</option>
<option>Overheat cooldown</option>
<option>Safety interlock opened</option>
<option>Cleaning / 5S</option>
</select>

<button onclick="submitReason()">Submit</button>
<button onclick="closeModal()" style="background:#e5e7eb;color:#000">Cancel</button>
</div>
</div>

<script>
/* CONFIG */
const CONFIG={
API:"https://plantwiz.pimateck.in/api",
DEVICE:"991cf500-661a-11f0-90f1-775fee303094",
KEYS:[
"Downtime_Start_Time",
"Downtime_End_Time",
"Downtime_Duration",
"Downtime_Description"
]
};

const JWT=new URLSearchParams(location.search).get("token")||"";
let selectedTs=null;

/* RANGE */
function getRange(){
const type=document.getElementById("range").value;
const now=Date.now();
let start;
if(type==="24H") start=now-86400000;
else{
const d=new Date();
d.setHours(0,0,0,0);
d.setDate(d.getDate()-d.getDay());
start=d.getTime();
}
return{startTs:start,endTs:now};
}

/* FETCH */
async function fetchDowntime(){
const {startTs,endTs}=getRange();
const url=
`${CONFIG.API}/plugins/telemetry/DEVICE/${CONFIG.DEVICE}/values/timeseries?keys=${CONFIG.KEYS.join(",")}&startTs=${startTs}&endTs=${endTs}&limit=1000&agg=NONE`;

const r=await fetch(url,{
headers:{"X-Authorization":`Bearer ${JWT}`}
});
return r.json();
}

/* MERGE */
function merge(obj){
const m=new Map();
for(const[k,a]of Object.entries(obj)){
(a||[]).forEach(p=>{
const r=m.get(p.ts)||{ts:p.ts};
r[k]=p.value;
m.set(p.ts,r);
});
}
return Array.from(m.values());
}

/* TABLE */
function renderTable(rows){
const tb=document.getElementById("downtimeTable");
tb.innerHTML="";
if(!rows.length){
tb.innerHTML="<tr><td colspan='4'>No downtime found</td></tr>";
return;
}
rows.forEach(r=>{
tb.innerHTML+=`
<tr>
<td>${new Date(+r.Downtime_Start_Time).toLocaleString()}</td>
<td>${new Date(+r.Downtime_End_Time).toLocaleString()}</td>
<td>${r.Downtime_Duration}</td>
<td>
${r.Downtime_Description||"—"}
<span class="dot" onclick='openModal(${JSON.stringify(r)})'>⋮</span>
</td>
</tr>`;
});
}

/* MODAL */
function openModal(r){
selectedTs=r.ts;
mStart.textContent=new Date(+r.Downtime_Start_Time).toLocaleString();
mEnd.textContent=new Date(+r.Downtime_End_Time).toLocaleString();
mDuration.textContent=r.Downtime_Duration;
mReason.value=r.Downtime_Description||"";
editModal.style.display="block";
}
function closeModal(){editModal.style.display="none";}

/* UPDATE */
async function submitReason(){
await fetch(
`${CONFIG.API}/plugins/telemetry/DEVICE/${CONFIG.DEVICE}/timeseries/ANY?ts=${selectedTs}`,
{
method:"POST",
headers:{
"Content-Type":"application/json",
"X-Authorization":`Bearer ${JWT}`
},
body:JSON.stringify({Downtime_Description:mReason.value})
});
closeModal();
loadTable();
}

/* MAIN */
async function loadTable(){
status.textContent="Loading...";
const raw=await fetchDowntime();
const rows=merge(raw);
renderTable(rows);
status.textContent="Loaded ✅";
}
</script>

</body>
</html>
