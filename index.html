<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Downtime Table</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Segoe UI",sans-serif;
  background:#f3f4f6;
  margin:0;color:#1e293b
}
.page{padding:20px}
.card{
  background:#fff;border-radius:12px;
  padding:16px 20px;margin-bottom:20px;
  box-shadow:0 2px 10px rgba(0,0,0,.08)
}
h2{margin:0 0 14px;color:#1e3a8a;font-size:18px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left}
th{background:#f1f5f9}
.dot{cursor:pointer;font-weight:bold;float:right}
#status{font-size:14px;color:#475569}

/* Modal */
.modal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.4);z-index:10
}
.modal-box{
  background:#fff;width:420px;
  margin:8% auto;padding:20px;
  border-radius:10px
}
.modal-box h3{margin-top:0}
select,button{
  padding:8px 12px;border-radius:6px;
  border:1px solid #cbd5e1;font-size:14px
}
button{
  background:#2563eb;color:#fff;
  border:none;cursor:pointer;font-weight:600
}
button:hover{background:#1d4ed8}
</style>
</head>

<body>
<div class="page">

<!-- TABLE -->
<div class="card">
<h2>Downtime Events (Last 24 Hours)</h2>
<table>
<thead>
<tr>
<th>Start Time</th>
<th>End Time</th>
<th>Duration (min)</th>
<th>Downtime Description</th>
</tr>
</thead>
<tbody id="downtimeTable">
<tr><td colspan="4">Loading...</td></tr>
</tbody>
</table>
<p id="status">—</p>
</div>

</div>

<!-- EDIT MODAL -->
<div id="editModal" class="modal">
<div class="modal-box">
<h3>Edit Downtime Reason</h3>

<p><b>Start Time:</b> <span id="mStart"></span></p>
<p><b>End Time:</b> <span id="mEnd"></span></p>
<p><b>Duration:</b> <span id="mDuration"></span> min</p>

<label>Downtime Reason</label>
<select id="mReason" style="width:100%;margin:10px 0">
<option>Power failure</option>
<option>Planned maintenance</option>
<option>Material shortage</option>
<option>Changeover / Setup</option>
<option>Lubrication cycle</option>
<option>Quality inspection hold</option>
<option>Unplanned breakdown</option>
<option>Overheat cooldown</option>
<option>Safety interlock opened</option>
<option>Cleaning / 5S</option>
</select>

<button onclick="submitReason()">Submit</button>
<button onclick="closeModal()" style="background:#e5e7eb;color:#000">Cancel</button>
</div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const CONFIG = {
  API: "https://plantwiz.pimateck.in/api",
  DEVICE_ID: "991cf500-661a-11f0-90f1-775fee303094",
  KEYS: [
    "Downtime_Start_Time",
    "Downtime_End_Time",
    "Downtime_Duration",
    "Downtime_Description"
  ]
};

/* =========================
   JWT
========================= */
const JWT = new URLSearchParams(location.search).get("token") || "";
let selectedTs = null;

/* =========================
   LAST 24 HOURS RANGE
========================= */
function getLast24H() {
  const now = Date.now();
  return { startTs: now - 86400000, endTs: now };
}

/* =========================
   FETCH DATA
========================= */
async function fetchDowntime() {
  const { startTs, endTs } = getLast24H();
  const url =
    `${CONFIG.API}/plugins/telemetry/DEVICE/${CONFIG.DEVICE_ID}/values/timeseries` +
    `?keys=${CONFIG.KEYS.join(",")}&startTs=${startTs}&endTs=${endTs}&limit=1000&agg=NONE`;

  const res = await fetch(url, {
    headers: { "X-Authorization": `Bearer ${JWT}` }
  });

  return res.json();
}

/* =========================
   MERGE SERIES
========================= */
function mergeSeries(obj) {
  const map = new Map();
  for (const [key, arr] of Object.entries(obj)) {
    (arr || []).forEach(p => {
      const row = map.get(p.ts) || { ts: p.ts };
      row[key] = p.value;
      map.set(p.ts, row);
    });
  }
  return Array.from(map.values());
}

/* =========================
   RENDER TABLE
========================= */
function renderTable(rows) {
  const tb = document.getElementById("downtimeTable");
  tb.innerHTML = "";

  rows.forEach(r => {
    tb.innerHTML += `
      <tr>
        <td>${new Date(+r.Downtime_Start_Time).toLocaleString()}</td>
        <td>${new Date(+r.Downtime_End_Time).toLocaleString()}</td>
        <td>${r.Downtime_Duration}</td>
        <td>
          ${r.Downtime_Description || "—"}
          <span class="dot" onclick='openModal(${JSON.stringify(r)})'>⋮</span>
        </td>
      </tr>`;
  });
}

/* =========================
   MODAL
========================= */
function openModal(row) {
  selectedTs = row.ts;

  mStart.textContent = new Date(+row.Downtime_Start_Time).toLocaleString();
  mEnd.textContent = new Date(+row.Downtime_End_Time).toLocaleString();
  mDuration.textContent = row.Downtime_Duration;
  mReason.value = row.Downtime_Description || "";

  editModal.style.display = "block";
}

function closeModal() {
  editModal.style.display = "none";
}

/* =========================
   UPDATE REASON
========================= */
async function submitReason() {
  const url =
    `${CONFIG.API}/plugins/telemetry/DEVICE/${CONFIG.DEVICE_ID}/timeseries/ANY?ts=${selectedTs}`;

  await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Authorization": `Bearer ${JWT}`
    },
    body: JSON.stringify({
      Downtime_Description: mReason.value
    })
  });

  closeModal();
  loadTable();
}

/* =========================
   INIT
========================= */
async function loadTable() {
  document.getElementById("status").textContent = "Loading...";
  const raw = await fetchDowntime();
  const rows = mergeSeries(raw);
  renderTable(rows);
  document.getElementById("status").textContent = "Loaded ✅";
}

loadTable();
</script>

</body>
</html>
